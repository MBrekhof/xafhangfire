@using DevExpress.Blazor

<style>
    .kv-input {
        border: 1px solid #d2d2d2;
        border-radius: 2px;
        padding: 5px 10px;
        font-size: inherit;
        line-height: 1.5;
        color: inherit;
        background-color: #fff;
        transition: border-color 0.15s ease-in-out;
        width: 100%;
    }
    .kv-input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: none;
    }
    .kv-input::placeholder {
        color: #adadad;
    }
</style>

@if (ShowRawEditor)
{
    <DxMemo Value="@RawJson"
            ValueChanged="@((string v) => OnRawJsonChanged(v))"
            Rows="6" />
}
else
{
    string currentGroup = null;
    @foreach (var field in Fields)
    {
        if (field.GroupName != null && field.GroupName != currentGroup)
        {
            currentGroup = field.GroupName;
            <div class="mt-3 mb-2 fw-bold text-muted border-bottom pb-1">@FormatGroupName(field.GroupName)</div>
        }
        <div class="mb-2">
            <label class="xaf-field-caption">@field.DisplayName@(field.IsRequired ? " *" : "")</label>
            @switch (field.FieldType)
            {
                case "int":
                    <DxSpinEdit Value="@field.IntValue"
                                ValueChanged="@((int v) => OnIntChanged(field, v))"
                                CssClass="w-100" />
                    break;
                case "bool":
                    <DxCheckBox Checked="@field.BoolValue"
                                CheckedChanged="@((bool v) => OnBoolChanged(field, v))" />
                    break;
                case "date":
                    <input type="date" class="kv-input"
                           value="@(field.DateTimeValue?.ToString("yyyy-MM-dd"))"
                           @onchange="@(e => OnDateInputChanged(field, e.Value?.ToString()))" />
                    break;
                case "decimal":
                    <DxSpinEdit Value="@field.DecimalValue"
                                ValueChanged="@((decimal v) => OnDecimalChanged(field, v))"
                                CssClass="w-100" />
                    break;
                case "lookup":
                    <DxComboBox TData="LookupItem"
                                TValue="string"
                                Data="@field.LookupItems"
                                Value="@field.StringValue"
                                ValueChanged="@((string v) => OnStringChanged(field, v))"
                                ValueFieldName="Id"
                                TextFieldName="DisplayText"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                NullText="Select..."
                                CssClass="w-100" />
                    break;
                case "dropdown":
                    <DxComboBox Data="@field.DropdownItems"
                                Value="@field.StringValue"
                                ValueChanged="@((string v) => OnStringChanged(field, v))"
                                AllowUserInput="true"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                NullText="Select..."
                                CssClass="w-100" />
                    break;
                case "keyvalue":
                    <div class="border rounded p-2">
                        @foreach (var kvp in field.KeyValuePairs)
                        {
                            <div @key="kvp" class="d-flex gap-2 mb-1 align-items-center">
                                <input type="text" class="kv-input flex-grow-1" placeholder="Key"
                                       value="@kvp.Key"
                                       @onchange="@(e => OnKvKeyChanged(field, kvp, e.Value?.ToString() ?? string.Empty))" />
                                <input type="text" class="kv-input flex-grow-1" placeholder="Value"
                                       value="@kvp.Value"
                                       @onchange="@(e => OnKvValueChanged(field, kvp, e.Value?.ToString() ?? string.Empty))" />
                                <DxButton RenderStyle="ButtonRenderStyle.Danger"
                                          RenderStyleMode="ButtonRenderStyleMode.Outline"
                                          IconCssClass="oi oi-trash"
                                          Click="@(() => OnKvRemove(field, kvp))" />
                            </div>
                        }
                        <DxButton Text="Add Parameter"
                                  RenderStyle="ButtonRenderStyle.Secondary"
                                  RenderStyleMode="ButtonRenderStyleMode.Outline"
                                  IconCssClass="oi oi-plus"
                                  Click="@(() => OnKvAdd(field))"
                                  CssClass="mt-1" />
                    </div>
                    break;
                case "json":
                    <DxMemo Value="@field.StringValue"
                            ValueChanged="@((string v) => OnStringChanged(field, v))"
                            Rows="3" CssClass="w-100" />
                    break;
                default:
                    <DxTextBox Value="@field.StringValue"
                               ValueChanged="@((string v) => OnStringChanged(field, v))"
                               CssClass="w-100" />
                    break;
            }
        </div>
    }
}

@code {
    [Parameter]
    public List<ParameterFieldModel> Fields { get; set; } = new();

    [Parameter]
    public bool ShowRawEditor { get; set; }

    [Parameter]
    public string RawJson { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> RawJsonChanged { get; set; }

    private async Task OnRawJsonChanged(string value)
    {
        await RawJsonChanged.InvokeAsync(value);
    }

    private async Task OnStringChanged(ParameterFieldModel field, string value)
    {
        field.StringValue = value;
        await NotifyJsonChanged();
    }

    private async Task OnIntChanged(ParameterFieldModel field, int value)
    {
        field.IntValue = value;
        await NotifyJsonChanged();
    }

    private async Task OnBoolChanged(ParameterFieldModel field, bool value)
    {
        field.BoolValue = value;
        await NotifyJsonChanged();
    }

    private async Task OnDateInputChanged(ParameterFieldModel field, string value)
    {
        field.DateTimeValue = DateTime.TryParse(value, out var dt) ? dt : null;
        await NotifyJsonChanged();
    }

    private async Task OnDecimalChanged(ParameterFieldModel field, decimal value)
    {
        field.DecimalValue = value;
        await NotifyJsonChanged();
    }

    private async Task OnKvKeyChanged(ParameterFieldModel field, KeyValuePairModel kvp, string value)
    {
        kvp.Key = value;
        await NotifyJsonChanged();
    }

    private async Task OnKvValueChanged(ParameterFieldModel field, KeyValuePairModel kvp, string value)
    {
        kvp.Value = value;
        await NotifyJsonChanged();
    }

    private async Task OnKvRemove(ParameterFieldModel field, KeyValuePairModel kvp)
    {
        field.KeyValuePairs.Remove(kvp);
        await NotifyJsonChanged();
    }

    private async Task OnKvAdd(ParameterFieldModel field)
    {
        field.KeyValuePairs.Add(new KeyValuePairModel());
        await NotifyJsonChanged();
    }

    private async Task NotifyJsonChanged()
    {
        var json = SerializeFields();
        await RawJsonChanged.InvokeAsync(json);
    }

    private string SerializeFields()
    {
        var dict = new Dictionary<string, object>();
        var groups = new Dictionary<string, Dictionary<string, string>>();

        foreach (var field in Fields)
        {
            if (field.GroupName != null)
            {
                if (!groups.TryGetValue(field.GroupName, out var groupDict))
                {
                    groupDict = new Dictionary<string, string>();
                    groups[field.GroupName] = groupDict;
                }
                groupDict[field.Name] = field.FieldType switch
                {
                    "date" => field.DateTimeValue?.ToString("yyyy-MM-dd") ?? string.Empty,
                    "int" => field.IntValue.ToString(),
                    "decimal" => field.DecimalValue.ToString(),
                    "bool" => field.BoolValue.ToString().ToLowerInvariant(),
                    _ => field.StringValue ?? string.Empty,
                };
                continue;
            }

            switch (field.FieldType)
            {
                case "int":
                    dict[field.Name] = field.IntValue;
                    break;
                case "bool":
                    dict[field.Name] = field.BoolValue;
                    break;
                case "keyvalue":
                    var kvDict = new Dictionary<string, string>();
                    foreach (var kvp in field.KeyValuePairs)
                    {
                        if (!string.IsNullOrWhiteSpace(kvp.Key))
                            kvDict[kvp.Key] = kvp.Value;
                    }
                    if (kvDict.Count > 0)
                        dict[field.Name] = kvDict;
                    break;
                case "json":
                    try
                    {
                        dict[field.Name] = System.Text.Json.JsonSerializer.Deserialize<object>(field.StringValue);
                    }
                    catch
                    {
                        dict[field.Name] = field.StringValue;
                    }
                    break;
                default: // string, dropdown
                    if (!string.IsNullOrEmpty(field.StringValue))
                        dict[field.Name] = field.StringValue;
                    break;
            }
        }

        foreach (var (key, groupDict) in groups)
        {
            if (groupDict.Count > 0)
                dict[key] = groupDict;
        }

        return System.Text.Json.JsonSerializer.Serialize(dict,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = false });
    }

    private static string FormatGroupName(string name)
    {
        var result = new System.Text.StringBuilder();
        foreach (var c in name)
        {
            if (char.IsUpper(c) && result.Length > 0)
                result.Append(' ');
            result.Append(c);
        }
        return result.ToString();
    }
}
